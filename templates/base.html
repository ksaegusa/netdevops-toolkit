<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NetDevOps-Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              display: ["\"Alegreya Sans SC\"", "sans-serif"],
              body: ["\"Noto Sans JP\"", "sans-serif"],
            },
            colors: {
              sand: "#eaf3ff",
              ink: "#13233b",
              ember: "#2b6cb0",
              emberDark: "#1f4f7a",
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Alegreya+Sans+SC:wght@500;700&family=Noto+Sans+JP:wght@400;600;700&display=swap" />
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  </head>
  <body class="font-body">
    <main class="min-h-screen bg-gradient-to-b from-white via-sand to-white text-ink">
      <header class="mx-auto flex max-w-screen-2xl items-center justify-between px-6 pb-6 pt-8">
        <a href="/" class="text-lg font-semibold tracking-wide">NetDevOps-Toolkit</a>
        <nav class="flex flex-wrap items-center gap-3 text-sm font-semibold">
          <a href="/" class="rounded-full px-3 py-1 transition hover:bg-black/5">Parser</a>
          <a href="/regex" class="rounded-full px-3 py-1 transition hover:bg-black/5">Regex</a>
          <a href="/diff" class="rounded-full px-3 py-1 transition hover:bg-black/5">Diff</a>
          <a href="/telemetry" class="rounded-full px-3 py-1 transition hover:bg-black/5">Inspector</a>
          <a href="/model" class="rounded-full px-3 py-1 transition hover:bg-black/5">Model</a>
        </nav>
      </header>
      {% block content %}{% endblock %}
    </main>
    <script>
      const hasFile = (input) => Boolean(input && input.files && input.files.length > 0);
      const bindUploadToTextarea = (
        fileInput,
        form,
        textareaSelector,
        warningId,
        options = {}
      ) => {
        if (!fileInput || !form) return;
        if (fileInput.dataset.bound === "1") return;
        fileInput.dataset.bound = "1";
        fileInput.addEventListener("change", () => {
          if (!hasFile(fileInput)) return;
          const textarea = form.querySelector(textareaSelector);
          if (!textarea) return;
          const [file] = fileInput.files;
          const reader = new FileReader();
          reader.onload = () => {
            textarea.value = reader.result ?? "";
            textarea.dispatchEvent(new Event("input", { bubbles: true }));
            if (options.clearSelectSelector) {
              const select = form.querySelector(options.clearSelectSelector);
              if (select) select.value = "";
            }
            if (options.clearOnLoad) {
              fileInput.value = "";
            }
            toggleWarning(warningId, "");
          };
          reader.onerror = () => {
            toggleWarning(warningId, "テキストの読み込みに失敗しました。");
          };
          reader.readAsText(file);
        });
      };

      const toggleWarning = (id, message) => {
        if (!id) return true;
        const element = document.getElementById(id);
        if (!element) return true;
        if (message) {
          element.textContent = message;
          element.classList.remove("hidden");
          return false;
        }
        element.textContent = "";
        element.classList.add("hidden");
        return true;
      };

      const validateParserForm = (form) => {
        const templateName = form.querySelector("[name='template_name']")?.value.trim();
        const templateBody = form.querySelector("[name='template_body']")?.value.trim();
        const templateUpload = hasFile(form.querySelector("[name='template_upload']"));
        const rawText = form.querySelector("[name='raw_text']")?.value.trim();
        const textUpload = hasFile(form.querySelector("[name='text_upload']"));
        if (!rawText && !textUpload) {
          return toggleWarning("parser-warning", "テキストを入力するかアップロードしてください。");
        }
        if (!templateName && !templateBody && !templateUpload) {
          return toggleWarning("parser-warning", "テンプレートを選択・入力・アップロードしてください。");
        }
        return toggleWarning("parser-warning", "");
      };

      const validateRegexForm = (form) => {
        const pattern = form.querySelector("[name='pattern']")?.value.trim();
        const rawText = form.querySelector("[name='raw_text']")?.value.trim();
        const textUpload = hasFile(form.querySelector("[name='text_upload']"));
        if (!pattern) {
          return toggleWarning("regex-warning", "正規表現パターンを入力してください。");
        }
        if (!rawText && !textUpload) {
          return toggleWarning("regex-warning", "テキストを入力するかアップロードしてください。");
        }
        return toggleWarning("regex-warning", "");
      };

      const validateDiffForm = (form) => {
        const oldText = form.querySelector("[name='old_text']")?.value.trim();
        const newText = form.querySelector("[name='new_text']")?.value.trim();
        const oldUpload = hasFile(form.querySelector("[name='old_upload']"));
        const newUpload = hasFile(form.querySelector("[name='new_upload']"));
        if ((!oldText && !oldUpload) || (!newText && !newUpload)) {
          return toggleWarning("diff-warning", "比較元と比較先の両方を入力してください。");
        }
        return toggleWarning("diff-warning", "");
      };

      const validateInspectorForm = (form) => {
        const text = form.querySelector("[name='telemetry_text']")?.value.trim();
        const upload = hasFile(form.querySelector("[name='telemetry_upload']"));
        if (!text && !upload) {
          return toggleWarning("inspector-warning", "JSON/YAMLを入力するかアップロードしてください。");
        }
        return toggleWarning("inspector-warning", "");
      };

      const validateModelForm = (form) => {
        const text = form.querySelector("[name='model_text']")?.value.trim();
        const upload = hasFile(form.querySelector("[name='model_upload']"));
        if (!text && !upload) {
          return toggleWarning("model-warning", "YANGを入力するかアップロードしてください。");
        }
        return toggleWarning("model-warning", "");
      };

      const bindColumnResizers = (root = document) => {
        root.querySelectorAll("table").forEach((table) => {
          if (table.dataset.colResizeBound === "1") return;
          const handles = table.querySelectorAll("[data-col-resize-handle]");
          if (!handles.length) return;
          table.dataset.colResizeBound = "1";
          table.style.tableLayout = "fixed";
          table.style.width = "max-content";

          handles.forEach((handle) => {
            if (handle.dataset.bound === "1") return;
            handle.dataset.bound = "1";
            const th = handle.closest("th");
            if (!th) return;
            th.style.minWidth = "80px";

            const onPointerDown = (event) => {
              event.preventDefault();
              const startX = event.clientX;
              const startWidth = th.getBoundingClientRect().width;
              const onMove = (moveEvent) => {
                const delta = moveEvent.clientX - startX;
                const nextWidth = Math.max(60, startWidth + delta);
                th.style.width = `${nextWidth}px`;
              };
              const onUp = () => {
                document.removeEventListener("pointermove", onMove);
                document.removeEventListener("pointerup", onUp);
              };
              document.addEventListener("pointermove", onMove);
              document.addEventListener("pointerup", onUp);
            };
            handle.addEventListener("pointerdown", onPointerDown);
          });
        });
      };

      document.addEventListener("DOMContentLoaded", () => {
        const parserForm = document.getElementById("parser-form");
        if (!parserForm) return;
        const textUpload = parserForm.querySelector("[name='text_upload']");
        bindUploadToTextarea(textUpload, parserForm, "[name='raw_text']", "parser-warning");
        const templateUpload = parserForm.querySelector("[name='template_upload']");
        bindUploadToTextarea(
          templateUpload,
          parserForm,
          "[name='template_body']",
          "parser-warning",
          {
            clearOnLoad: true,
            clearSelectSelector: "[name='template_name']",
          }
        );
        bindColumnResizers(document);
      });

      document.body.addEventListener("htmx:afterSwap", (event) => {
        bindColumnResizers(event.target);
      });
    </script>
  </body>
</html>
